<!DOCTYPE html>
<html>
    <head>
  <script type="text/javascript">
        function setVoice() {
            var vid = document.getElementById("voice");
            if(vid!=null){
            	vid.volume = 0.2;
            }
        }
        window.onload = setVoice;
        </script>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
	  (adsbygoogle = window.adsbygoogle || []).push({
		google_ad_client: "ca-pub-0980023289791742",
		enable_page_level_ads: true
	  });
	</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama</title>
    <meta name="description" content="Merhabalar arkadaşlar.">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://ilkaygunel.com/blog/2018/securing-rest-web-service-spring-security-spring-boot-jwt/">
    <link rel="alternate" type="application/rss+xml" title="İlkay Günel - Blog" href="http://ilkaygunel.com/feed.xml" />
      <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama | İlkay Günel - Blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama" />
<meta name="author" content="İlkay Günel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama" />
<meta property="og:description" content="Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama" />
<link rel="canonical" href="http://ilkaygunel.com/blog/2018/securing-rest-web-service-spring-security-spring-boot-jwt/" />
<meta property="og:url" content="http://ilkaygunel.com/blog/2018/securing-rest-web-service-spring-security-spring-boot-jwt/" />
<meta property="og:site_name" content="İlkay Günel - Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-01-26T20:40:21+03:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://ilkaygunel.com/blog/2018/securing-rest-web-service-spring-security-spring-boot-jwt/","headline":"Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama","dateModified":"2018-01-26T20:40:21+03:00","datePublished":"2018-01-26T20:40:21+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://ilkaygunel.com/blog/2018/securing-rest-web-service-spring-security-spring-boot-jwt/"},"author":{"@type":"Person","name":"İlkay Günel"},"description":"Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76541903-2', 'auto');
  ga('send', 'pageview');
</script>

    <main>
      <header class="site-header">
  <div class="container">
    <h1><a href="/">Ana Sayfa</a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/ilkay-gunel-cv.pdf" title="Bana Ait CV">Bana Ait CV</a></li>
        
          <li><a href="/blog/2016/git-nedir" title="Git Nedir? Nasıl Kullanılır?">Git Nedir? Nasıl Kullanılır?</a></li>
        
          <li><a href="/blog/2017/angular-2-tutorials" title="Angular 2">Angular 2</a></li>
        
          <li><a href="/blog/2016/maven-tutorials" title="Maven">Maven</a></li>
        
          <li><a href="/blog/2016/jsf-tutorials-list" title="JSF">JSF</a></li>
        
          <li><a href="/blog/2016/spring-tutorials" title="Spring 4">Spring 4</a></li>
        
          <li><a href="/blog/2016/eclipselink" title="Eclipselink">Eclipselink</a></li>
        
          <li><a href="/blog/2016/resteasy/" title="Resteasy">Resteasy</a></li>
        
          <li><a href="/blog/2016/mongodb/" title="MongoDB&Java">MongoDB&Java</a></li>
        
          <li><a href="/blog/2016/test" title="Test">Test</a></li>
        
          <li><a href="/blog/2016/useful-libraries-for-java" title="Java İçin Faydalı Kütüphaneler">Java İçin Faydalı Kütüphaneler</a></li>
        
          <li><a href="/about" title="Hakkımda">Hakkımda</a></li>
        
          <li><a href="/blog/2016/eclipse-notes" title="Eclipse">Eclipse</a></li>
        
          <li><a href="/blog/2016/formula1/" title="Formula 1">Formula 1</a></li>
        
          <li><a href="/blog/2016/kitaplar" title="Kitaplar">Kitaplar</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
        <li><a href="https://1000kitap.com/ilkaygunel">1000Kitap</a></li>
      </ul>
    </nav>
	<div class="container">
		<ul class="social">
  <li><a href="https://www.instagram.com/ilkay_gunel/" target="_blank"><img src="/images/instagram.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="https://www.facebook.com/ilkay.gunel" target="_blank"><img src="/images/facebook.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="https://www.youtube.com/c/ilkaygunel" target="_blank"><img src="/images/youtube.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="http://twitter.com/ilkaygunel" target="_blank"><img src="/images/twitter.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="http://github.com/ilkgunel" target="_blank"><img src="/images/github.jpg" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="http://linkedin.com/in/ilkaygunel" target="_blank"><img src="/images/linkedin.png" style="width: 24px;height: 24px;"></img></a></li>
  
</ul>
	</div>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Spring Boot ve Spring Security İle Rest Servisi Koruma 3 - JSON Web Token İle Doğrulama</h1>
      <p class="post-meta">Jan 26, 2018</p>
    </header>

    <div class="post-content">
      <p>Merhabalar arkadaşlar.</p>

<p><a href="http://ilkaygunel.com/blog/2017/securing-rest-service-spring-security-spring-boot-inmemory/">InMemory User</a> ve <a href="http://ilkaygunel.com/blog/2018/securing-rest-webservice-spring-security-spring-boot-database/">DataBase’de Tanımlı Kullanıcılar</a>
yazılarımızda Spring Boot ve Spring Security ile bir Rest Web Servis’i Basic Authentication ile korumayı görmüştük.</p>

<p>Bu yazıda ise token bazlı doğrulama ve yetkilendirmeyi de görmüş olacağız ve bunu JSON Web Token kullanarak yapacağız. Yazıdaki örneğimiz bir önceki
yazıdaki örneğimizin üstüne eklemeler yapılmış hali olacak, bu nedenle yazının kapsamı içinde olmayan konuları es geçeceğim.</p>

<p>JSON Web Token hakkında bilgi edinmek ya da bilgi tazelemek için Rahman Hocamın <a href="https://kodedu.com/2017/03/jwt-json-web-tokens-nedir-ne-ise-yarar/">şuradaki</a>
yazısını okuyabilirsiniz.</p>

<p><strong>WebSecurityConfig.java</strong></p>

<p>WebSecurityConfig sınıfımız içerisinde sadece <strong><em>configure(HttpSecurity http)</em></strong> metodunda değişiklik yapacağız arkadaşlar.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">http</span><span class="o">.</span><span class="na">cors</span><span class="o">().</span><span class="na">configurationSource</span><span class="o">(</span><span class="n">request</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">CorsConfiguration</span><span class="o">().</span><span class="na">applyPermitDefaultValues</span><span class="o">()).</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">()</span>
				<span class="o">.</span><span class="na">disable</span><span class="o">().</span><span class="na">authorizeRequests</span><span class="o">()</span>
				<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&quot;/memberList&quot;</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">&quot;hasRole(&#39;ROLE_ADMIN&#39;)&quot;</span><span class="o">)</span>
				<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="s">&quot;/login&quot;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
				<span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="k">new</span> <span class="n">JWTLoginFilter</span><span class="o">(</span><span class="s">&quot;/login&quot;</span><span class="o">,</span> <span class="n">authenticationManager</span><span class="o">()),</span>
						<span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
				<span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="k">new</span> <span class="n">JWTAuthenticationFilter</span><span class="o">(),</span> <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span></code></pre></figure>

<p>Metodumuz içerisinde şu değişiklikleri yaptık:</p>

<ul>
  <li>
    <p>antMatchers(HttpMethod.POST, “/login”).permitAll() ifadesi ile /login path’ine sadece POST isteklerinin yapılabileceğini ve herkese açık olduğunu
söyledik.</p>
  </li>
  <li>
    <p>addFilterBefore(new JWTLoginFilter(“/login”, authenticationManager()),UsernamePasswordAuthenticationFilter.class) ifadesi ile /login path’ine yapılacak
tüm isteklerin JWTLoginFilter’dan geçmesini sağlıyoruz. JWTLoginFilter bize doğrulanmış kullanıcı için token bilgisi dönecek.</p>
  </li>
  <li>
    <p>addFilterBefore(new JWTAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class) satırı ile de login dışında kalan path’lere yapılacak 
isteklerin JWTAuthenticationFilter’dan geçmesini sağlıyoruz. JWTAuthenticationFilter, gelen istekler içerisinde token olup olmadığını kontrol edecek ve
token’dan ilgili bilgileri alıp Spring Security’e aktaracak.</p>
  </li>
</ul>

<p><strong>JWTLoginFilter.java</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">package</span> <span class="nn">com.ilkaygunel.filter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AuthenticationManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.util.matcher.AntPathRequestMatcher</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ilkaygunel.pojo.AccountCredentials</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ilkaygunel.security.TokenAuthenticationService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTLoginFilter</span> <span class="kd">extends</span> <span class="n">AbstractAuthenticationProcessingFilter</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="nf">JWTLoginFilter</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">AuthenticationManager</span> <span class="n">manager</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="k">new</span> <span class="n">AntPathRequestMatcher</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
		<span class="n">setAuthenticationManager</span><span class="o">(</span><span class="n">manager</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">arg1</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">AuthenticationException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">AccountCredentials</span> <span class="n">creds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">().</span><span class="na">readValue</span><span class="o">(</span><span class="n">arg0</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="n">AccountCredentials</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">getAuthenticationManager</span><span class="o">()</span>
				<span class="o">.</span><span class="na">authenticate</span><span class="o">(</span><span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">creds</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">creds</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">successfulAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">,</span>
			<span class="n">Authentication</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">TokenAuthenticationService</span><span class="o">.</span><span class="na">addAuthentication</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">auth</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>JWTLoginFilter sınıfı WebSecurityConfig sınıfında tanımladığımız üzere /login path’ine gelen istekleri önce attemptAuthentication() metodu ile gelen
username&amp;password’ü vererek Spring Security vasıtası ile doğrulatacak ve gelen user geçerli bir user ise  successfulAuthentication() metodu içerisinde
TokenAuthenticationService sınıfındaki addAuthentication() metodunu kullanarak dönülecek response’a bir token eklemesi yapacak.</p>

<script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<p><ins class="adsbygoogle" style="display:block" data-ad-format="fluid" data-ad-layout-key="-cv+40+9g-b3-3r" data-ad-client="ca-pub-0980023289791742" data-ad-slot="8632723594"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></p>

<p><strong>JWTAuthenticationFilter.java</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">package</span> <span class="nn">com.ilkaygunel.filter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.filter.GenericFilterBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.ilkaygunel.security.TokenAuthenticationService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTAuthenticationFilter</span> <span class="kd">extends</span> <span class="n">GenericFilterBean</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
		<span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">TokenAuthenticationService</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">((</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">);</span>

		<span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
		<span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>JWTAuthenticationFilter sınıfı WebSecurityConfig sınıfında da belirtildiği gibi /login path’i dışında kalmış olan tüm path’lere gelen istekleri 
denetleyecek olan sınıftır. doFilter() metodu TokenAuthenticationService sınıfındaki getAuthentication metodu ile bir adet Authentication nesnesi alır
ve SecurityContextHolder.getContext().setAuthentication(authentication) kod satırındaki <strong><em>setAuthentication()</em></strong> metoduna bu Authentication nesnesini
parametre olarak geçirir. setAuthentication() metodu kendisine gelen Authentication nesnesi ile
gelen bilgilere sahip user’ın gerçekten olup olmadığı ve yetkisinin ne olduğu durumlarına bakar. Akabinde JWTAuthenticationFilter 
filterChain.doFilter() ile red ya da kabul işlemini yaparak görevini tamamlar.</p>

<p><strong>TokenAuthenticationService.java</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">package</span> <span class="nn">com.ilkaygunel.security</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedHashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ilkaygunel.pojo.AccountCredentials</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.jsonwebtoken.Claims</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.Jwts</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.SignatureAlgorithm</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">java.util.Collections.emptyList</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenAuthenticationService</span> <span class="o">{</span>

	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">EXPIRATIONTIME</span> <span class="o">=</span> <span class="mi">864_000_000</span><span class="o">;</span> <span class="c1">// 10 days</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SECRET</span> <span class="o">=</span> <span class="s">&quot;ThisIsASecret&quot;</span><span class="o">;</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOKEN_PREFIX</span> <span class="o">=</span> <span class="s">&quot;Bearer&quot;</span><span class="o">;</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">HEADER_STRING</span> <span class="o">=</span> <span class="s">&quot;Authorization&quot;</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addAuthentication</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">Authentication</span> <span class="n">auth</span><span class="o">)</span> <span class="o">{</span>

		<span class="n">String</span> <span class="n">concattedRoles</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">GrantedAuthority</span> <span class="n">ga</span> <span class="o">:</span> <span class="n">auth</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">concattedRoles</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">concattedRoles</span> <span class="o">+=</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">ga</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">concattedRoles</span> <span class="o">+=</span> <span class="n">ga</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">();</span>
			<span class="o">}</span>

		<span class="o">}</span>

		<span class="n">String</span> <span class="n">JWT</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">setSubject</span><span class="o">(</span><span class="n">auth</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">claim</span><span class="o">(</span><span class="s">&quot;roles&quot;</span><span class="o">,</span> <span class="n">concattedRoles</span><span class="o">)</span>
				<span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">EXPIRATIONTIME</span><span class="o">))</span>
				<span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">,</span> <span class="n">SECRET</span><span class="o">).</span><span class="na">compact</span><span class="o">();</span>
		<span class="n">res</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="n">HEADER_STRING</span><span class="o">,</span> <span class="n">TOKEN_PREFIX</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">JWT</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Authentication</span> <span class="nf">getAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">HEADER_STRING</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">SECRET</span><span class="o">).</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">TOKEN_PREFIX</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">))</span>
					<span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">user</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
			<span class="n">String</span> <span class="n">roles</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;roles&quot;</span><span class="o">);</span>
			<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">roleList</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">roles</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\s*,\\s*&quot;</span><span class="o">));</span>
			<span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">grantedAuths</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;();</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">roleList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">SimpleGrantedAuthority</span> <span class="n">abv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="n">roleList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
				<span class="n">grantedAuths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">abv</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">grantedAuths</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>TokenAuthenticationService sınıfı içerisinde <strong><em>addAuthentication(…)</em></strong> ve <strong><em>getAuthentication(…)</em></strong> metotları yer almakta. addAuthentication(…)
metodu</p>

<ul>
  <li>
    <p>Authentication nesnesi üzerindeki rolleri <strong><em>concattedRoles</em></strong> String’inde virgüllerle ayrılmış şekilde tutar. Bir sistem üzerindeki bir kullanıcının
birden fazla rolü olabilir, bu nedenle kullanıcıya verilecek token içerisinde kullanıcının sahip olduğu tüm roller de olmalıdır.</p>
  </li>
  <li>
    <p>JWT string’ini elde ettiğimiz satırda ise setSubject(…) metoduna kullanıcı adını geçiriyoruz.</p>
  </li>
  <li>
    <p>claim(…) metoduna key-value çifti halinde parametre geçiriyoruz ve kullanıcının sahip olduğu rolleri tutan <strong><em>concattedRoles</em></strong> String’ini
<strong><em>roles</em></strong> key’i ile kaydediyoruz. claim(…) metodunu daha çok token içerisinde gidip gelmesini istediğimiz alanlar için kullanıyoruz.</p>
  </li>
  <li>
    <p>setExpiration(…) metodu ile token’ın ne kadar süre için geçerli olacağını söylüyoruz. Bizim örneğimizde 10 günlük bir expiration time var.</p>
  </li>
  <li>
    <p>signWith(…) metoduna bir hash algoritması ve bir de hash sırasında kullanılacak gizli bir anahtar bilgisini geçirerek JWT tokenımızı imzalıyoruz.</p>
  </li>
  <li>
    <p>Son olarak compact(…) metodu ile de String tiğindeki JWT token’ı elde ediyoruz.</p>
  </li>
  <li>
    <p>Elde ettiğimiz toke’ı da res.addHeader(…) diyerek HEADER_STRING değişkeninin değeri ile response’a ekliyoruz.</p>
  </li>
</ul>

<p>getAuthentication(…) metodu ise,</p>

<ul>
  <li>
    <p>request nesnesinin header’ından  HEADER_STRING değişkenin değeri ile token’ı alıyor.</p>
  </li>
  <li>
    <p>Eğer token gelmiş ise Claims yani diğer payload kısmından veriler almaya başlıyoruz. Daha önce subject’e koyduğumuz username’i ve roles bilgilerini
alıyoruz. roles nesnesi birden fazla role var ise virgüllerle ayrılmış halde olacağı için öncelikle virgüllerle ayrılmış o string’den bir liste 
(<strong><em>roleList</em></strong>) elde ediyoruz ve bir for döngüsü ile <strong><em>GrantedAuthority</em></strong> tipinde veri tutan listeye bu rolleri ekliyoruz.</p>
  </li>
  <li>
    <p>Son adımda ise username’ti tutan user değişkeni boş değil ise UsernamePasswordAuthenticationToken sınıfının yapılandırıcısına user, null ve rolleri
tutan grantedAuths nesnelerini geçirerek UsernamePasswordAuthenticationToken nesnesini döndürüyoruz.</p>
  </li>
</ul>

<p><strong>AccountCredentials.java</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">package</span> <span class="nn">com.ilkaygunel.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountCredentials</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">roles</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">username</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">password</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getRoles</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">roles</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRoles</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">roles</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">roles</span> <span class="o">=</span> <span class="n">roles</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>AccountCredentials sınıfı da gelen kullanıcı için bilgiler tutacağımız basit bir pojo sınıfı.</p>

<p><strong>Ekran Görüntüleri</strong></p>

<p>Şimdi Postman üzerinden http://localhost:8080/SpringSecurityWithSpringBoot/login adresine body kısmında raw halde aşağıdaki ekran görüntüsünde olan 
JSON’ı POST ediyorum ve cevap kısmında bana token dönüşü oluyor:</p>

<p><a href="/images/springBootSecurityRest/9.png">
<img src="/images/springBootSecurityRest/9.png" style="width: 958px; height= 400px;" />
</a></p>

<p>Bu token ile şimdi de http://localhost:8080/SpringSecurityWithSpringBoot/memberList adresine header içerisinde Authorization key’i ile edindiğim token’ı
bulundurarak GET isteği gönderiyorum. Web servis bana ilgili verileri dönüyor.</p>

<p><a href="/images/springBootSecurityRest/10.png">
<img src="/images/springBootSecurityRest/10.png" style="width: 958px; height= 400px;" />
</a></p>

<p>Şimdi rolü ROLE_USER olan bir kullanıcı ile aynı işlemi deniyelim.</p>

<p><a href="/images/springBootSecurityRest/11.png">
<img src="/images/springBootSecurityRest/11.png" style="width: 958px; height= 400px;" />
</a></p>

<p>Gördüğümüz gibi Spring Security role yetkili olmadığı için ilgili kaynağa erişimimi reddediyor.</p>

<p><a href="/images/springBootSecurityRest/12.png">
<img src="/images/springBootSecurityRest/12.png" style="width: 958px; height= 400px;" />
</a></p>

<p>Bu yazıda anlatacaklarım bu kadar arkadaşlar. Başka bir yazıda görüşene kadar sağlıcakla kalın.</p>

<p style="text-align: center">Selam ve Sevgilerimle</p>

    </div>

    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
/*
var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//ilkaygunel-com.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>                                    
  </div>
</aside>

  </div>

</article>

      </div>

      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://www.instagram.com/ilkay_gunel/" target="_blank"><img src="/images/instagram.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="https://www.facebook.com/ilkay.gunel" target="_blank"><img src="/images/facebook.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="https://www.youtube.com/c/ilkaygunel" target="_blank"><img src="/images/youtube.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="http://twitter.com/ilkaygunel" target="_blank"><img src="/images/twitter.png" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="http://github.com/ilkgunel" target="_blank"><img src="/images/github.jpg" style="width: 24px;height: 24px;"></img></a></li>
  <li><a href="http://linkedin.com/in/ilkaygunel" target="_blank"><img src="/images/linkedin.png" style="width: 24px;height: 24px;"></img></a></li>
  
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2019 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <a href="http://github.com/ilkgunel/ilkgunel.github.io" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
      <script>
      $(document).ready(function() {
        $('.sliding-panel-button,.sliding-panel-fade-screen,.sliding-panel-close').on('click touchstart',function (e) {
          $('.sliding-panel-content,.sliding-panel-fade-screen').toggleClass('is-visible');
          e.preventDefault();
        });
      });
      </script>
    </main>
  </body>
</html>
